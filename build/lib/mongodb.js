// Generated by CoffeeScript 1.3.1
(function() {
  var MongoDbPubSubAdapter, mongo, url;

  mongo = require('mongodb');

  url = require('url');

  MongoDbPubSubAdapter = require('./mongodb/pubsub');

  exports.connect = function(urlstring, collection_name, callback) {
    return mongo.Db.connect(urlstring, function(err, db) {
      var coll, theurl;
      theurl = url.parse(urlstring);
      console.log("Attempting connection to " + theurl.protocol + "//" + theurl.hostname + " (complete URL suppressed)");
      return db.collection((coll = collection_name), function(err, collection) {
        return collection.isCapped(function(err, capped) {
          if (err) {
            callback("Error when detecting capped collection. Aborting. Capped collections are necessary for tailed cursors.");
          }
          if (!capped) {
            callback("'" + coll + "' is not a capped collection. Aborting. Please use a capped collection for tailable cursors.");
          }
          console.log("Successfully connected to " + theurl.protocol + "//" + theurl.hostname + ".");
          return callback(null, new MongoDbPubSubAdapter(collection));
        });
      });
    });
  };

}).call(this);
